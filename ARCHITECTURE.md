



Message Router - это высокопроизводительная система маршрутизации сообщений без блокировок, способная обрабатывать миллионы сообщений в секунду через несколько этапов обработки.



```
┌──────────┐     ┌────────┐     ┌──────────┐     ┌────────┐     ┌──────────┐
│Producer 0│────►│        │────►│Processor0│────►│        │────►│Strategy 0│
├──────────┤     │Primary │     ├──────────┤     │Second  │     ├──────────┤
│Producer 1│────►│        │────►│Processor1│────►│        │────►│Strategy 1│
├──────────┤     │        │     ├──────────┤     │        │     ├──────────┤
│Producer 2│────►│Router  │     │Processor2│────►│Router  │     │Strategy 2│
├──────────┤     │        │     ├──────────┤     │        │     └──────────┘
│Producer 3│────►│        │────►│Processor3│────►│        │
└──────────┘     └────────┘     └──────────┘     └────────┘
                 (Stage 1)       (Processing)      (Stage 2)      (End Consumers)
```




- **Назначение**: Генерируют сообщения с высокой скоростью
- **Количество**: 4-8 потоков (настраивается)
- **Функции**:
  - Генерация сообщений по заданному распределению типов
  - Поддержка burst-режима для тестирования всплесков
  - Отслеживание статистики производства


- **Назначение**: Обрабатывают сообщения с симуляцией работы
- **Количество**: 4-8 потоков (настраивается)
- **Функции**:
  - Получение сообщений из Stage1 очередей
  - Симуляция обработки с настраиваемым временем
  - Маршрутизация в Stage2 очереди по типу сообщения


- **Назначение**: Конечные потребители, проверяющие порядок
- **Количество**: 2-4 потока (настраивается)
- **Функции**:
  - Получение обработанных сообщений
  - Проверка упорядочивания по производителю и типу
  - Симуляция финальной обработки


- **SPSC (Single Producer Single Consumer)**: Для связи Producer → Processor
- **MPMC (Multiple Producer Multiple Consumer)**: Для связи Processor → Strategy
- **Особенности**:
  - Кольцевой буфер с атомарными операциями
  - Выравнивание по кэш-линиям для оптимизации
  - Неблокирующие операции push/pop


- **Назначение**: Отслеживание производительности в реальном времени
- **Функции**:
  - Статистика пропускной способности
  - Мониторинг глубины очередей
  - Измерение латентности
  - Проверка упорядочивания



### Lock-Free Design
- **Никаких мьютексов, семафоров или условных переменных**
- **Только атомарные операции** для синхронизации
- **Busy waiting** для минимальной латентности


- **Выравнивание по кэш-линиям** для часто используемых структур
- **Минимизация выделения памяти** на горячем пути
- **Предварительное выделение буферов**


- **Неблокирующие операции записи** в очереди
- **Отслеживание потери сообщений** при переполнении
- **Мониторинг глубины очередей** для предотвращения блокировок



1. **Генерация**: Производители создают сообщения с уникальными ID и временными метками
2. **Stage1 маршрутизация**: Сообщения направляются в соответствующие процессоры по типу
3. **Обработка**: Процессоры выполняют симуляцию работы и обновляют сообщения
4. **Stage2 маршрутизация**: Обработанные сообщения направляются в стратегии
5. **Валидация**: Стратегии проверяют упорядочивание и завершают обработку




- `producers.count`: Количество производителей
- `producers.messages_per_sec`: Скорость генерации сообщений
- `processors.count`: Количество процессоров
- `strategies.count`: Количество стратегий
- `duration_secs`: Длительность теста


- `stage1_rules`: Сопоставление типов сообщений с процессорами
- `stage2_rules`: Сопоставление типов сообщений со стратегиями
- `ordering_required`: Требование упорядочивания для каждого типа


- `burst_enabled`: Включение режима всплесков
- `burst_duration_ms`: Длительность всплеска
- `quiet_duration_ms`: Длительность тихого периода
- `burst_multiplier`: Множитель скорости для всплеска
- `quiet_multiplier`: Множитель скорости для тихого периода



### 1. Baseline
- Равномерное распределение нагрузки
- 4M сообщений/сек общих
- Проверка базовой функциональности

### 2. Hot Message Type
- 70% сообщений типа 0 (горячая точка)
- Тестирование несбалансированной нагрузки
- Проверка устойчивости к узким местам

### 3. Burst Traffic
- Чередующиеся периоды высокой и низкой нагрузки
- Тестирование обработки всплесков
- Проверка стабильности очередей

### 4. Imbalanced Processing
- Разные времена обработки по типам сообщений
- Тестирование независимости процессоров
- Проверка отсутствия блокировок

### 5. Ordering Stress Test
- Все сообщения одного типа через один процессор
- Экстремальная конкуренция за ресурсы
- Проверка сохранения порядка

### 6. Strategy Bottleneck
- Медленная стратегия создает узкое место
- Тестирование обработки обратного давления
- Проверка отсутствия потерь сообщений



### Queue Performance
- Измерение пропускной способности очередей
- Сравнение SPSC vs MPMC производительности
- Тестирование многопоточности

### Routing Latency
- Измерение задержки маршрутизации
- Тестирование масштабирования правил
- Анализ кэш-эффективности

### Memory Allocation
- Измерение выделения памяти
- Тестирование различных размеров структур
- Анализ паттернов использования памяти

### Scaling Benchmark
- Тестирование масштабирования по потокам
- Анализ узких мест производительности
- Оптимизация конфигурации



- **Пропускная способность**: 10+ миллионов сообщений/сек
- **Латентность end-to-end (p99)**: < 5 микросекунд
- **Потеря сообщений**: 0
- **Нарушения порядка**: 0



- **ОС**: Linux (Ubuntu 22+ рекомендуется)
- **Компилятор**: C++20 или новее, Clang 19+
- **Зависимости**: Google Benchmark, JSON library
- **Docker**: 20+ и Docker Compose 2+
- **Память**: 4GB+ RAM
- **CPU**: 4+ ядер для оптимальной производительности
